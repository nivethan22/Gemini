name: "‚ö° EnigMano Win11 + 128 Cores Deployment"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"
      CRD_PIN:
        description: "Chrome Remote Desktop PIN (6+ digits)"
        required: true
        default: "123456"
      CRD_TOKEN:
        description: "Paste the Auth Code (starts with 4/...) from Google Headless"
        required: true
        default: ""

jobs:
  deploy-enigmano:
    name: "üöÄ Deploy EnigMano Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm # Note: windows-11-arm implies a specific runner type, ensure this matches your available runners. Standard is 'windows-latest' (x64).

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      CRD_PIN: ${{ github.event.inputs.CRD_PIN }}
      CRD_TOKEN: ${{ github.event.inputs.CRD_TOKEN }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano-Win-11-128-Cores.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: üìå Deployment Parameters
        shell: pwsh
        run: |
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host "==============================================="
          Write-Host "üîπ EnigMano Instance     : $env:INSTANCE_ID"
          Write-Host "üî¢ Previous Instance     : $prevInstance"
          Write-Host "üì¶ GitHub Repository     : $env:REPO"
          Write-Host "üîÅ Deployment Workflow   : $env:WORKFLOW_FILE"
          Write-Host "üÜî Deployment ID         : $env:DEPLOYMENT_ID"
          Write-Host "==============================================="

      - name: üîê Validate Inputs
        shell: pwsh
        run: |
          if (-not $env:CRD_PIN) {
            Write-Error "‚ùå Missing Chrome Remote Desktop PIN"
            exit 1
          }
          if (-not $env:CRD_TOKEN) {
            Write-Error "‚ùå Missing Chrome Remote Desktop Token (Auth Code)"
            exit 1
          }
          Write-Host "‚úÖ All required inputs validated successfully"

      - name: ‚öôÔ∏è Install & Configure Chrome Remote Desktop
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'

          # 1. Download CRD
          Write-Host "üåê Downloading CRD Host..."
          $url = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $output = "$env:TEMP\crd.msi"
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing

          # 2. Install CRD
          Write-Host "üíæ Installing CRD Host..."
          Start-Process msiexec.exe -ArgumentList "/i `"$output`" /qn" -Wait

          # 3. Register and Start Service using Official Binary
          Write-Host "üîë Registering CRD Host..."
          $crdExecutable = "C:\Program Files (x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          
          if (-not (Test-Path $crdExecutable)) {
            Write-Error "‚ùå CRD Executable not found. Installation failed."
            exit 1
          }

          # Clean the token if the user pasted the full command by mistake (simple cleanup)
          $authToken = $env:CRD_TOKEN
          if ($authToken -match 'code="([^"]+)"') {
              $authToken = $matches[1]
              Write-Host "‚ö†Ô∏è Detected full command string, extracted code: $authToken"
          }

          $hostName = "EnigMano-Instance-$env:INSTANCE_ID"

          # Execute the registration command
          # This command creates the registry keys, performs the OAuth exchange, and starts the service safely.
          & $crdExecutable --code="$authToken" `
                           --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
                           --name="$hostName" `
                           --pin="$env:CRD_PIN"

          Write-Host "‚úÖ CRD setup complete. You can now connect via https://remotedesktop.google.com/access"

      - name: üèÉ Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "‚úÖ Runner is active. Connect via Chrome Remote Desktop."
          Write-Host "This job will stay alive for approximately 6 hours."
          
          # Loop to keep alive (more robust than a single sleep)
          $seconds = 21600 # 6 hours
          while ($seconds -gt 0) {
            Start-Sleep -Seconds 60
            $seconds -= 60
            if ($seconds % 300 -eq 0) {
              Write-Host "‚è≥ Time remaining: $([math]::Round($seconds/60)) minutes..."
            }
          }
          Write-Host "Job timeout reached. Shutting down."

      - name: üí† Final Status
        if: always()
        shell: pwsh
        run: |
          Write-Host "‚úÖ CRD session for Instance $env:INSTANCE_ID finished."
          Write-Host "üîã Powered by: SHAHZAIB-YT"
          Write-Host "üèÅ CRD deployment complete."
