name: "Win Latest CRD Only"

on:
  workflow_dispatch:
    inputs:
      CRD_CODE:
        description: "Paste the CRD Code (starts with 4/...)"
        required: true
      CRD_PIN:
        description: "6-digit PIN"
        required: true
        default: "123456"

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: üñ•Ô∏è Set up Virtual Display (CRITICAL)
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        $extractPath = "C:\usbmmidd"
        $certPath = Join-Path $extractPath "usbmmidd.cer"
        $exePath = Join-Path $extractPath "deviceinstaller64.exe"
        
        Write-Host "‚¨áÔ∏è Downloading & Extracting Virtual Display Driver..."
        Invoke-WebRequest -Uri "https://www.amyuni.com/downloads/usbmmidd_v2.zip" -OutFile "$env:TEMP\usbmmidd.zip"
        Expand-Archive -Path "$env:TEMP\usbmmidd.zip" -DestinationPath $extractPath -Force
        
        # 1. Install Certificate (using full path to the cert)
        Write-Host "üîê Installing Certificate..."
        certutil -addstore "TrustedPublisher" $certPath
        
        # 2. Install Device (using full path to the executable)
        Write-Host "‚öôÔ∏è Installing Device..."
        & $exePath install (Join-Path $extractPath "usbmmidd.inf") usbmmidd
        
        # 3. Enable Display (using full path to the executable)
        Write-Host "üì∫ Enabling Display..."
        & $exePath enableidd 1

    - name: ‚¨áÔ∏è Install Chrome Remote Desktop
      shell: pwsh
      run: |
        $crdUrl = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
        $crdDest = "$env:TEMP\crd.msi"
        
        Invoke-WebRequest -Uri $crdUrl -OutFile $crdDest
        Start-Process msiexec.exe -ArgumentList "/i `"$crdDest`" /qn" -Wait
        Start-Sleep -Seconds 5

    - name: üîó Register Host
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        
        # FIX: Using the reliable $env:ProgramFilesX86 variable to avoid PowerShell parsing issues with parentheses.
        $crdExecutable = Join-Path $env:ProgramFilesX86 "Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        
        # Fallback for 64-bit installation path
        if (-not (Test-Path $crdExecutable)) {
            $crdExecutable = Join-Path $env:ProgramFiles "Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        }
        
        if (-not (Test-Path $crdExecutable)) {
            Write-Error "‚ùå Chrome Remote Desktop executable not found."
            exit 1
        }
        
        # Run the registration command using the call operator (&)
        # Note: We trust the GitHub input ${{ github.event.inputs.CRD_CODE }} is the code itself.
        & $crdExecutable --code="${{ github.event.inputs.CRD_CODE }}" `
                         --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
                         --name="GitHub-Win-Latest" `
                         --pin="${{ github.event.inputs.CRD_PIN }}"
        
        Write-Host "‚úÖ CRD Host registered successfully."

    - name: üïí Keep Alive (6 Hours)
      shell: pwsh
      run: |
        Write-Host "Connect at https://remotedesktop.google.com/access"
        # 6 hours = 360 minutes
        for ($i=0; $i -lt 360; $i++) {
            Start-Sleep -Seconds 60
            Write-Host "Time remaining: $(360 - $i) minutes"
        }
