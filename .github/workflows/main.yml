name: Chrome Remote Desktop (ULTIMATE OPTIMIZATION - FIXED)

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Paste the Windows (PowerShell) command from Google Headless:'
        required: true
      pin:
        description: 'Set your 6-digit PIN (Default: 123456). Overrides CRD_PIN secret.'
        required: false
        default: '123456'

jobs:
  rdp_session:
    runs-on: windows-latest

    steps:
    # 1. ‚öôÔ∏è Setup Environment & Install Resolution Tool
    - name: ‚öôÔ∏è Setup Environment & Pre-Requisites
      run: |
        # Disable the "Server Manager" popup
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\ServerManager' -Name 'DoNotOpenServerManagerAtLogon' -Value 1
        
        # Install resolution utility (FIXED URL for NirCmd)
        Write-Host "Downloading NirCmd Resolution Tool..."
        $nircmdUrl = "https://www.nirsoft.net/utils/nircmd.zip" # Fixed URL
        Invoke-WebRequest -Uri $nircmdUrl -OutFile "nircmd.zip"
        Expand-Archive nircmd.zip -DestinationPath "C:\setres"
        
        # Enable script execution for this session
        Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
        
        Start-Service "Audiosrv"
        Set-Service "Audiosrv" -StartupType Automatic

    # 2. ‚ö° VM Optimization (Debloat)
    - name: ‚ö° Debloat and Optimize Windows Server (Hex Parsing Fixed)
      shell: powershell
      run: |
        Write-Host "Starting aggressive system optimization..."
        
        # --- Disable Unnecessary Services ---
        $ServicesToDisable = @("Fax", "PrintSpooler", "WSearch", "DiagTrack", "cbdhsvc", "MapsBroker", "OneSyncSvc", "TrkWks", "dmwappushservice", "DoSvc")
        foreach ($svc in $ServicesToDisable) {
            try { Get-Service -Name $svc | Set-Service -StartupType Disabled -ErrorAction Stop } catch {}
        }
        
        # Disable Telemetry via Registry
        Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -Value 0 -Type DWord -Force
        
        # --- Visual Performance Tweaks (FIXED PARSING ERROR) ---
        # UserPreferencesMask value for disabling most visual effects (fixed by defining the byte array correctly)
        [byte[]]$bytes = 0x90, 0x12, 0x01, 0x80, 0x10, 0x00, 0x00, 0x00
        Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -Value $bytes -Type Binary -Force
        
        Write-Host "Optimization complete."

    # 3. Install Chrome Remote Desktop
    - name: ‚¨áÔ∏è Install Chrome Remote Desktop
      run: |
        Write-Host "Downloading MSI..."
        # FIXED URL for CRD Installer
        $crdUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" 
        Invoke-WebRequest -Uri $crdUrl -OutFile "crd.msi"
        
        Write-Host "Installing..."
        Start-Process -FilePath "msiexec.exe" -ArgumentList "/i crd.msi /qn" -Wait

    # 4. Set Resolution and Initialize Host
    - name: üì∫ Set Resolution to 1600x900 and Start Host
      env:
        MY_PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        # --- Resolution Fix ---
        Write-Host "Setting resolution to 1600x900..."
        C:\setres\nircmdc.exe setdisplay 1600 900 32
        
        # --- Host Registration ---
        if ($Env:INPUT_CMD -match '(4/[^"\s]+)') {
            $code = $matches[1]
            Write-Host "‚úÖ OAuth Code detected: $code"
        } else {
            Write-Error "‚ùå Could not find a valid code starting with '4/'. Please check your input."
            exit 1
        }

        $binary = Get-ChildItem "C:\Program Files (x86)\Google\Chrome Remote Desktop" -Recurse -Filter "remoting_start_host.exe" | Select-Object -ExpandProperty FullName -First 1

        Write-Host "üöÄ Registering Runner..."
        & $binary --code=$code --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="GitHub-VPS" --pin=$Env:MY_PIN
        
        Write-Host "--------------------------------------------------------"
        Write-Host "üéâ SUCCESS! The OPTIMIZED VPS is Online." -ForegroundColor Green
        Write-Host "üëâ Connect here: https://remotedesktop.google.com/access"
        Write-Host "üîë PIN: $Env:MY_PIN"
        Write-Host "--------------------------------------------------------"

    # 5. Keep Alive
    - name: üõë Keep Alive
      run: |
        while ($true) { Start-Sleep -Seconds 60 }
