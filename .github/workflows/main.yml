name: "Win Latest CRD Only"

on:
  workflow_dispatch:
    inputs:
      CRD_CODE:
        description: "Paste the CRD Code (starts with 4/...)"
        required: true
      CRD_PIN:
        description: "6-digit PIN"
        required: true
        default: "123456"

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: üñ•Ô∏è Set up Virtual Display (Required for Video)
      run: |
        $url = "https://www.amyuni.com/downloads/usbmmidd_v2.zip"
        $dest = "$env:TEMP\usbmmidd.zip"
        Invoke-WebRequest -Uri $url -OutFile $dest
        Expand-Archive -Path $dest -DestinationPath "C:\usbmmidd" -Force
        cd C:\usbmmidd
        certutil -addstore "TrustedPublisher" .\usbmmidd.cer
        .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
        .\deviceinstaller64.exe enableidd 1

    - name: ‚¨áÔ∏è Install Chrome Remote Desktop
      run: |
        $crdUrl = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
        $crdDest = "$env:TEMP\crd.msi"
        Invoke-WebRequest -Uri $crdUrl -OutFile $crdDest
        Start-Process msiexec.exe -ArgumentList "/i `"$crdDest`" /qn" -Wait

    - name: üîó Register Host
      run: |
        $crdPath = "$env:ProgramFiles(x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        if (-not (Test-Path $crdPath)) { $crdPath = "$env:ProgramFiles\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe" }
        
        # Clean the input code if user pasted the full command
        $code = "${{ github.event.inputs.CRD_CODE }}"
        if ($code -match 'code="([^"]+)"') { $code = $matches[1] }
        
        & $crdPath --code="$code" --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="GitHub-Win-Latest" --pin="${{ github.event.inputs.CRD_PIN }}"

    - name: üïí Keep Alive (6 Hours)
      run: |
        Write-Host "Connect at https://remotedesktop.google.com/access"
        $files = Get-ChildItem -Path "C:\Windows\System32"
        # Simple loop to keep CPU active and runner alive
        for ($i=0; $i -lt 360; $i++) {
            Start-Sleep -Seconds 60
            Write-Host "Time remaining: $(360 - $i) minutes"
        }
