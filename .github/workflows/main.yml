name: "‚ö° EnigMano Win11 + 128 Cores Deployment (Optimized)"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"
      CRD_PIN:
        description: "PIN for the Remote Desktop (6 digits)"
        required: true
        default: "123456"
      CRD_TOKEN:
        description: "Paste the Auth Code (starts with 4/...) or full command"
        required: true
        default: ""
      ZEROTIER_NETWORK_ID:
        description: "Your 16-digit ZeroTier Network ID. Optional."
        required: false
        default: ""

jobs:
  deploy-enigmano:
    name: "üöÄ Deploy EnigMano Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-latest # Changed from windows-11-arm for compatibility

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      CRD_PIN: ${{ github.event.inputs.CRD_PIN }}
      CRD_TOKEN: ${{ github.event.inputs.CRD_TOKEN }}
      ZEROTIER_NETWORK_ID: ${{ github.event.inputs.ZEROTIER_NETWORK_ID }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano-Win-11-128-Cores.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: üìå Deployment Parameters
        shell: pwsh
        run: |
          Write-Host "==============================================="
          Write-Host "üîπ EnigMano Instance     : $env:INSTANCE_ID"
          Write-Host "==============================================="

      - name: üîê Validate Inputs
        shell: pwsh
        run: |
          if (-not $env:CRD_TOKEN) { Write-Error "‚ùå Missing CRD Token." ; exit 1 }
          if (-not $env:ZEROTIER_NETWORK_ID) { Write-Warning "‚ö†Ô∏è Skipping ZeroTier." }
          Write-Host "‚úÖ Inputs validated."

      ---

      - name: üíª Install Virtual Display Driver (Fixes Lag)
        shell: pwsh
        run: |
          Write-Host "üåê Downloading and Installing ViGEm Bus Driver (Virtual Display)..."
          $url = "https://github.com/ViGEm/ViGEmBus/releases/download/v1.17.333.0/ViGEmBus_Setup_1.17.333.0.exe"
          $output = "$env:TEMP\vigem.exe"
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing

          Write-Host "üíæ Installing ViGEm..."
          Start-Process -FilePath "$output" -ArgumentList "/S" -Wait # /S is silent install
          Write-Host "‚úÖ Virtual Display Driver installed."
          
      ---

      - name: ‚öôÔ∏è Install & Configure Chrome Remote Desktop
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          # Download, Install, and Register CRD (using the robust remoting_start_host.exe method)
          Write-Host "üåê Downloading & Installing CRD Host..."
          $url = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $output = "$env:TEMP\crd.msi"
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing
          Start-Process msiexec.exe -ArgumentList "/i `"$output`" /qn" -Wait

          Write-Host "üîë Registering CRD Host..."
          $crdExecutable = "${Env:PROGRAMFILES(X86)}\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
          
          # Logic to handle full command paste vs. just the code
          $authToken = $env:CRD_TOKEN
          if ($authToken -match 'code="([^"]+)"') { $authToken = $matches[1] }

          $hostName = "EnigMano-Instance-$env:INSTANCE_ID"

          & $crdExecutable --code="$authToken" `
                           --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
                           --name="$hostName" `
                           --pin="$env:CRD_PIN"

          Write-Host "‚úÖ CRD setup complete."
          
      ---

      - name: ‚òÄÔ∏è Install & Configure Sunshine (for Moonlight)
        shell: pwsh
        run: |
          Write-Host "üåê Downloading Sunshine (Streaming Server for Moonlight)..."
          # Using a portable ZIP to avoid service install complexities
          $url = "https://github.com/LizardByte/Sunshine/releases/download/v0.22.0/sunshine-windows-portable.zip"
          $zipFile = "$env:TEMP\sunshine.zip"
          $installPath = "C:\Sunshine"

          Invoke-WebRequest -Uri $url -OutFile $zipFile -UseBasicParsing
          Expand-Archive -Path $zipFile -DestinationPath $installPath -Force

          Write-Host "üî• Starting Sunshine Service..."
          # Start the server in the background
          Start-Process -FilePath "$installPath\sunshine.exe" -ArgumentList "-d" -Wait -PassThru 
          
          Write-Host "‚úÖ Sunshine (Moonlight Server) is now running."
          
      ---

      - name: üåç Install & Connect ZeroTier
        if: ${{ github.event.inputs.ZEROTIER_NETWORK_ID != '' }}
        shell: pwsh
        run: |
          Write-Host "üåê Downloading ZeroTier One..."
          $url = "https://download.zerotier.com/dist/ZeroTier%20One.msi"
          $output = "$env:TEMP\zerotier.msi"
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing

          Write-Host "üíæ Installing ZeroTier..."
          # Silent install: /i is install, /qn is quiet no UI, /norestart
          Start-Process msiexec.exe -ArgumentList "/i `"$output`" /qn /norestart" -Wait

          Write-Host "üîó Joining ZeroTier Network..."
          # Path to the CLI executable after installation
          $ztPath = "C:\Program Files\ZeroTier\One\zerotier-cli.exe"
          
          if (Test-Path $ztPath) {
             # Join the network
             & $ztPath join $env:ZEROTIER_NETWORK_ID
             
             # Wait a moment for network assignment
             Start-Sleep -Seconds 10
             
             Write-Host "‚úÖ ZeroTier Joined. You must authorize this node in your ZeroTier Central console."
             Write-Host "   Node Status:"
             & $ztPath info
          } else {
             Write-Error "‚ùå ZeroTier installation failed."
          }
          
      ---

      - name: üèÉ Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "‚úÖ Runner is active. Session is ready."
          Write-Host "üëâ Connect via CRD: https://remotedesktop.google.com/access"
          if ($env:ZEROTIER_NETWORK_ID) {
             Write-Host "üëâ Connect Sunshine/Moonlight via ZeroTier IP (Authorize the node first!)."
          }
          
          $seconds = 21600 # 6 hours
          while ($seconds -gt 0) {
            Start-Sleep -Seconds 60
            $seconds -= 60
            if ($seconds % 300 -eq 0) {
              Write-Host "‚è≥ Time remaining: $([math]::Round($seconds/60)) minutes..."
            }
          }

      - name: üí† Final Status
        if: always()
        shell: pwsh
        run: Write-Host "üèÅ Session Finished."
