name: "âš¡ EnigMano Win11 + 128 Cores Deployment"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"

jobs:
  deploy-enigmano:
    name: "ğŸš€ Deploy EnigMano Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      CRD_PIN: ${{ secrets.CRD_PIN }}
      CRD_TOKEN: ${{ secrets.CRD_TOKEN }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano-Win-11-128-Cores.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: ğŸ“Œ Deployment Parameters
        shell: pwsh
        run: |
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host "==============================================="
          Write-Host "ğŸ”¹ EnigMano Instance     : $env:INSTANCE_ID"
          Write-Host "ğŸ”¢ Previous Instance     : $prevInstance"
          Write-Host "ğŸ“¦ GitHub Repository     : $env:REPO"
          Write-Host "ğŸ” Deployment Workflow   : $env:WORKFLOW_FILE"
          Write-Host "ğŸ†” Deployment ID         : $env:DEPLOYMENT_ID"
          Write-Host "==============================================="

      - name: ğŸ” Validate Secrets
        shell: pwsh
        run: |
          if (-not $env:CRD_PIN) {
            Write-Error "âŒ Missing GitHub Secret: CRD_PIN"
            exit 1
          }
          if (-not $env:CRD_TOKEN) {
            Write-Error "âŒ Missing GitHub Secret: CRD_TOKEN"
            exit 1
          }
          Write-Host "âœ… All required secrets validated successfully"

      - name: âš™ï¸ Install & Configure Chrome Remote Desktop
        shell: pwsh
        run: |
          $script = @"
          function Get-CrdPinHash([string]`$pin) {
              `$bytes = [System.Text.Encoding]::UTF8.GetBytes(`$pin)
              `$sha256 = [System.Security.Cryptography.SHA256]::Create()
              `$hash = `$sha256.ComputeHash(`$bytes)
              return [System.Convert]::ToBase64String(`$hash)
          }

          Write-Host "ğŸŒ Downloading CRD Host..."
          `$url = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          `$output = "crd.msi"
          Invoke-WebRequest -Uri `$url -OutFile `$output -UseBasicParsing

          Write-Host "ğŸ’¾ Installing CRD Host..."
          Start-Process msiexec.exe -ArgumentList "/i `"`$output`" /qn" -Wait

          Write-Host "ğŸ”‘ Configuring CRD Host..."
          `$regPath = "HKLM:\SOFTWARE\Policies\Google\Chrome Remote Desktop"
          if (!(Test-Path `$regPath)) {
              New-Item -Path `$regPath -Force
          }
          
          Set-ItemProperty -Path `$regPath -Name "RemoteAccessHostFirewallTraversal" -Value 1
          Set-ItemProperty -Path `$regPath -Name "RemoteAccessHostAllowRelayedConnection" -Value 1
          Set-ItemProperty -Path `$regPath -Name "RemoteAccessHostAllowClientPairing" -Value 1
          
          # Set the Refresh Token
          Set-ItemProperty -Path `$regPath -Name "RemoteAccessHostRefreshToken" -Value `$env:CRD_TOKEN
          
          # Set the PIN
          `$pinHash = Get-CrdPinHash -pin `$env:CRD_PIN
          Set-ItemProperty -Path `$regPath -Name "RemoteAccessHostPinHash" -Value `$pinHash
          
          Write-Host "ğŸš€ Starting CRD Service..."
          Start-Service -Name "chromoting"
          
          Write-Host "âœ… CRD setup complete. You can now connect."
          "@

          $script | Out-File "setup_crd.ps1" -Encoding "utf8"
          powershell.exe -ExecutionPolicy Bypass -File ".\setup_crd.ps1"

      - name: ğŸƒ Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "âœ… Runner is active. You can connect via Chrome Remote Desktop."
          Write-Host "This job will stay alive for approximately 5 hours and 50 minutes."
          Start-Sleep -Seconds 21000
          Write-Host "Job timeout reached. Shutting down."

      - name: ğŸ’  Final Status
        if: always()
        shell: pwsh
        run: |
          Write-Host "âœ… CRD session for Instance $env:INSTANCE_ID finished."
          Write-Host "ğŸ”‹ Powered by: SHAHZAIB-YT"
          Write-Host "ğŸ CRD deployment complete."
