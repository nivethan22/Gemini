name: Chrome Remote Desktop (Fixed)

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Paste the Windows (PowerShell) command from Google Headless:'
        required: true
      pin:
        description: 'Set your 6-digit PIN (Default: 123456)'
        required: false
        default: '123456'

jobs:
  rdp_session:
    runs-on: windows-latest

    steps:
    # 1. Setup Environment
    - name: ‚öôÔ∏è Setup Environment
      run: |
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\ServerManager' -Name 'DoNotOpenServerManagerAtLogon' -Value 1
        Start-Service "Audiosrv"
        Set-Service "Audiosrv" -StartupType Automatic

    # 2. Install Chrome Remote Desktop (FIXED LINK)
    - name: ‚¨áÔ∏è Install Chrome Remote Desktop
      run: |
        Write-Host "Downloading MSI..."
        # The URL below is the official static link for the Windows Installer
        $url = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
        Invoke-WebRequest -Uri $url -OutFile "crd.msi"
        
        Write-Host "Installing..."
        Start-Process -FilePath "msiexec.exe" -ArgumentList "/i crd.msi /qn" -Wait

    # 3. Initialize the Host
    - name: üöÄ Start CRD Host
      env:
        MY_PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        # Extract the OAuth Code using Regex to prevent copy-paste errors
        if ($Env:INPUT_CMD -match '(4/[^"\s]+)') {
            $code = $matches[1]
            Write-Host "‚úÖ OAuth Code detected: $code"
        } else {
            Write-Error "‚ùå Could not find a valid code starting with '4/'. Please check your input."
            exit 1
        }

        # Find the installed binary (Path is standard)
        $binary = "C:\Program Files (x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        
        if (-not (Test-Path $binary)) {
            Write-Host "‚ö†Ô∏è Standard path not found, searching..."
            $binary = Get-ChildItem "C:\Program Files (x86)\Google\Chrome Remote Desktop" -Recurse -Filter "remoting_start_host.exe" | Select-Object -ExpandProperty FullName -First 1
        }

        if (-not $binary) {
             Write-Error "‚ùå CRD Binary not found. Installation failed."
             exit 1
        }

        # Run the Registration
        Write-Host "üöÄ Registering Runner..."
        & $binary --code=$code --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="GitHub-VPS" --pin=$Env:MY_PIN
        
        Write-Host "--------------------------------------------------------"
        Write-Host "üéâ SUCCESS! The VPS is Online." -ForegroundColor Green
        Write-Host "üëâ Connect here: https://remotedesktop.google.com/access"
        Write-Host "üîë PIN: $Env:MY_PIN"
        Write-Host "--------------------------------------------------------"

    # 4. Keep Alive
    - name: üõë Keep Alive
      run: |
        while ($true) { Start-Sleep -Seconds 60 }
