name: "‚ö° EnigMano Win11 + 128 Cores Deployment"

on:
  workflow_dispatch:
    inputs:
      INSTANCE:
        description: "Instance number to deploy (e.g., 1, 2, 3...)"
        required: true
        default: "1"
      # New input for the Chrome Remote Desktop PIN
      CRD_PIN:
        description: "Chrome Remote Desktop PIN (6+ digits)"
        required: true
        default: ""
      # New input for the Chrome Remote Desktop Refresh Token
      CRD_TOKEN:
        description: "Chrome Remote Desktop Refresh Token"
        required: true
        default: ""

jobs:
  deploy-enigmano:
    name: "üöÄ Deploy EnigMano Instance ${{ github.event.inputs.INSTANCE }}"
    runs-on: windows-11-arm

    env:
      INSTANCE_ID: ${{ github.event.inputs.INSTANCE }}
      # Now pulling CRD credentials from workflow inputs instead of secrets
      CRD_PIN: ${{ github.event.inputs.CRD_PIN }}
      CRD_TOKEN: ${{ github.event.inputs.CRD_TOKEN }}
      REPO: ${{ github.repository }}
      WORKFLOW_FILE: "enigmano-Win-11-128-Cores.yml"
      DEPLOYMENT_ID: ${{ github.run_id }}

    steps:
      - name: üìå Deployment Parameters
        shell: pwsh
        run: |
          $prevInstance = [int]$env:INSTANCE_ID - 1
          Write-Host "==============================================="
          Write-Host "üîπ EnigMano Instance     : $env:INSTANCE_ID"
          Write-Host "üî¢ Previous Instance     : $prevInstance"
          Write-Host "üì¶ GitHub Repository     : $env:REPO"
          Write-Host "üîÅ Deployment Workflow   : $env:WORKFLOW_FILE"
          Write-Host "üÜî Deployment ID         : $env:DEPLOYMENT_ID"
          Write-Host "==============================================="

      - name: üîê Validate Inputs
        shell: pwsh
        run: |
          if (-not $env:CRD_PIN) {
            Write-Error "‚ùå Missing Chrome Remote Desktop PIN"
            exit 1
          }
          if (-not $env:CRD_TOKEN) {
            Write-Error "‚ùå Missing Chrome Remote Desktop Token"
            exit 1
          }
          Write-Host "‚úÖ All required inputs validated successfully"

      - name: ‚öôÔ∏è Install & Configure Chrome Remote Desktop
        shell: pwsh
        # The script is now run directly using the YAML multi-line feature (|)
        # This avoids the complex escaping issues of the PowerShell here-string (")
        run: |
          function Get-CrdPinHash([string]$pin) {
              $bytes = [System.Text.Encoding]::UTF8.GetBytes($pin)
              $sha256 = [System.Security.Cryptography.SHA256]::Create()
              $hash = $sha256.ComputeHash($bytes)
              return [System.Convert]::ToBase64String($hash)
          }

          Write-Host "üåê Downloading CRD Host..."
          $url = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
          $output = "crd.msi"
          Invoke-WebRequest -Uri $url -OutFile $output -UseBasicParsing

          Write-Host "üíæ Installing CRD Host..."
          Start-Process msiexec.exe -ArgumentList "/i `"$output`" /qn" -Wait

          Write-Host "üîë Configuring CRD Host..."
          $regPath = "HKLM:\SOFTWARE\Policies\Google\Chrome Remote Desktop"
          if (!(Test-Path $regPath)) {
              New-Item -Path $regPath -Force
          }
          
          Set-ItemProperty -Path $regPath -Name "RemoteAccessHostFirewallTraversal" -Value 1
          Set-ItemProperty -Path $regPath -Name "RemoteAccessHostAllowRelayedConnection" -Value 1
          Set-ItemProperty -Path $regPath -Name "RemoteAccessHostAllowClientPairing" -Value 1
          
          # Set the Refresh Token
          # NOTE: $env:CRD_TOKEN is directly accessible here
          Set-ItemProperty -Path $regPath -Name "RemoteAccessHostRefreshToken" -Value $env:CRD_TOKEN
          
          # Set the PIN
          # NOTE: $env:CRD_PIN is directly accessible here
          $pinHash = Get-CrdPinHash -pin $env:CRD_PIN
          Set-ItemProperty -Path $regPath -Name "RemoteAccessHostPinHash" -Value $pinHash
          
          Write-Host "üöÄ Starting CRD Service..."
          Start-Service -Name "chromoting"
          
          Write-Host "‚úÖ CRD setup complete. You can now connect."

      - name: üèÉ Keep Runner Alive
        shell: pwsh
        run: |
          Write-Host "‚úÖ Runner is active. You can connect via Chrome Remote Desktop."
          Write-Host "This job will stay alive for approximately 5 hours and 50 minutes."
          Start-Sleep -Seconds 21000
          Write-Host "Job timeout reached. Shutting down."

      - name: üí† Final Status
        if: always()
        shell: pwsh
        run: |
          Write-Host "‚úÖ CRD session for Instance $env:INSTANCE_ID finished."
          Write-Host "üîã Powered by: SHAHZAIB-YT"
          Write-Host "üèÅ CRD deployment complete."
