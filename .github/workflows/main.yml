name: Chrome Remote Desktop (Pro)

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Paste the Windows (PowerShell) command from Google Headless:'
        required: true

jobs:
  rdp_session:
    runs-on: windows-latest

    steps:
    # 1. Setup Environment
    - name: ‚öôÔ∏è Setup Environment
      run: |
        # Disable the "Server Manager" popup usually seen on Server 2019/2022
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\ServerManager' -Name 'DoNotOpenServerManagerAtLogon' -Value 1
        
        # Enable Audio Service (Optional, but good for Moonlight/Media)
        Start-Service "Audiosrv"
        Set-Service "Audiosrv" -StartupType Automatic

    # 2. Install Chrome Remote Desktop
    - name: ‚¨áÔ∏è Install Chrome Remote Desktop
      run: |
        Write-Host "Downloading MSI..."
        Invoke-WebRequest -Uri "https://dl.google.com/hosted/chromeremotedesktop/chromeremotedesktop.msi" -OutFile "crd.msi"
        
        Write-Host "Installing..."
        Start-Process -FilePath "msiexec.exe" -ArgumentList "/i crd.msi /qn" -Wait

    # 3. Initialize the Host (The Magic Step)
    - name: üöÄ Start CRD Host
      env:
        # If you didn't make a secret, it defaults to 123456
        MY_PIN: ${{ secrets.CRD_PIN || '123456' }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        # 1. Clean the input to get just the OAuth Code
        # The user might paste ".\remoting_start_host.exe --code=4/xxxx" or just "4/xxxx"
        # We look for the pattern "4/" followed by any non-quote characters
        if ($Env:INPUT_CMD -match '(4/[^"\s]+)') {
            $code = $matches[1]
            Write-Host "‚úÖ OAuth Code detected: $code"
        } else {
            Write-Error "‚ùå Could not find a valid code starting with '4/'. Did you paste the right command?"
            exit 1
        }

        # 2. Find the CRD Host Binary (Path varies by version)
        $binary = Get-ChildItem "C:\Program Files (x86)\Google\Chrome Remote Desktop" -Recurse -Filter "remoting_start_host.exe" | Select-Object -ExpandProperty FullName -First 1
        
        if (-not $binary) {
            Write-Error "‚ùå CRD Binary not found."
            exit 1
        }

        # 3. Execute the Registration
        # We append the redirect URL and the PIN automatically
        Write-Host "üöÄ Registering Runner..."
        & $binary --code=$code --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="GitHub-VPS" --pin=$Env:MY_PIN
        
        Write-Host "--------------------------------------------------------"
        Write-Host "üéâ SUCCESS! The VPS is Online." -ForegroundColor Green
        Write-Host "üëâ Connect here: https://remotedesktop.google.com/access"
        Write-Host "üîë PIN: $Env:MY_PIN"
        Write-Host "--------------------------------------------------------"

    # 4. Anti-Exit Loop
    - name: üõë Keep Alive
      run: |
        while ($true) { Start-Sleep -Seconds 60 }
