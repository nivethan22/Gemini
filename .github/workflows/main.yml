name: Apollo Moonlight (Hybrid - AUTO FIXED)

on:
  workflow_dispatch:
    inputs:
      auth_code:
        description: 'Google CRD PowerShell Command (needed for initial pairing):'
        required: true
      pin:
        description: 'CRD Pin (Default: 123456)'
        required: false
        default: '123456'
      zerotier_id:
        description: 'ZeroTier Network ID (Required for Moonlight connection):'
        required: true

jobs:
  moonlight_setup:
    runs-on: windows-latest

    steps:
    # 1. ‚öôÔ∏è Setup Environment & Virtual Display (Fixed Pathing)
    - name: ‚öôÔ∏è Setup Environment & Virtual Display
      run: |
        # Disable Server Manager
        Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\ServerManager' -Name 'DoNotOpenServerManagerAtLogon' -Value 1
        
        # Enable Audio
        Start-Service "Audiosrv"
        Set-Service "Audiosrv" -StartupType Automatic

        # --- Install Virtual Display Driver (usbmmidd) ---
        Write-Host "Downloading Virtual Display Driver..."
        $url = "https://www.amyuni.com/downloads/usbmmidd_v2.zip"
        Invoke-WebRequest -Uri $url -OutFile "usbmmidd.zip"
        
        Expand-Archive usbmmidd.zip -DestinationPath "C:\usbmmidd_extracted"
        
        # üîç DYNAMICALLY FIND THE INSTALLER
        $binaryPath = Get-ChildItem -Path "C:\usbmmidd_extracted" -Recurse -Filter "deviceinstaller64.exe" | Select-Object -ExpandProperty DirectoryName -First 1
        
        if (-not $binaryPath) { Write-Error "Could not find deviceinstaller64.exe"; exit 1 }

        Write-Host "Installer found in: $binaryPath"
        cd $binaryPath
        
        cmd /c deviceinstaller64.exe install usbmmidd.inf usbmmidd
        cmd /c deviceinstaller64.exe enableidd 1
        Write-Host "Virtual Display Activated."

    # 2. ‚ö° Install ZeroTier
    - name: üåê Install & Join ZeroTier
      env:
        ZT_NET: ${{ inputs.zerotier_id }}
      run: |
        Write-Host "Installing ZeroTier..."
        choco install zerotier-one -y
        
        Write-Host "Waiting for ZeroTier service..."
        for ($i=0; $i -lt 20; $i++) {
            if (Get-Service "ZeroTierOneService" -ErrorAction SilentlyContinue) { break }
            Start-Sleep -Seconds 2
        }
        
        Write-Host "Joining Network: $Env:ZT_NET"
        & "C:\Program Files (x86)\ZeroTier\One\zerotier-cli.bat" join $Env:ZT_NET
        
        Write-Host "‚úÖ Joined. PLEASE AUTHORIZE THIS MEMBER IN YOUR ZEROTIER DASHBOARD NOW."

    # 3. ‚òÄÔ∏è Install Sunshine (AUTO-UPDATE FIX)
    - name: ‚òÄÔ∏è Install Sunshine (Automatic Latest Version)
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        Write-Host "Fetching the absolute latest Sunshine release from GitHub API..."
        
        # Securely fetch the latest release data
        $headers = @{Authorization = "token $env:GITHUB_TOKEN"}
        $latest = Invoke-RestMethod -Uri "https://api.github.com/repos/LizardByte/Sunshine/releases/latest" -Headers $headers
        
        # Automatically find the asset that ends with 'installer.exe' (avoids version mismatch errors)
        $installerUrl = $latest.assets | Where-Object { $_.name -like "*Windows*installer.exe" } | Select-Object -ExpandProperty browser_download_url | Select-Object -First 1
        
        if (-not $installerUrl) {
            Write-Error "‚ùå Could not find a valid Windows Installer in the latest release."
            exit 1
        }
        
        Write-Host "‚¨áÔ∏è Downloading from: $installerUrl"
        Invoke-WebRequest -Uri $installerUrl -OutFile "sunshine_setup.exe"
        
        Write-Host "üíø Installing..."
        Start-Process -FilePath ".\sunshine_setup.exe" -ArgumentList "/S" -Wait
        
        Start-Service "sunshine"
        Set-Service "sunshine" -StartupType Automatic
        Write-Host "‚úÖ Sunshine Installed & Running."

    # 4. ‚¨áÔ∏è Install Chrome Remote Desktop
    - name: ‚¨áÔ∏è Install Chrome Remote Desktop
      run: |
        $crdUrl = "https://dl.google.com/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi" 
        Invoke-WebRequest -Uri $crdUrl -OutFile "crd.msi"
        Start-Process -FilePath "msiexec.exe" -ArgumentList "/i crd.msi /qn" -Wait

    # 5. üöÄ Launch & Keep Alive
    - name: üöÄ Launch Services & Keep Alive
      env:
        MY_PIN: ${{ inputs.pin }}
        INPUT_CMD: ${{ inputs.auth_code }}
      run: |
        if ($Env:INPUT_CMD -match '(4/[^"\s]+)') { $code = $matches[1] }
        $binary = Get-ChildItem "C:\Program Files (x86)\Google\Chrome Remote Desktop" -Recurse -Filter "remoting_start_host.exe" | Select-Object -ExpandProperty FullName -First 1
        & $binary --code=$code --redirect-url="https://remotedesktop.google.com/_/oauthredirect" --name="Apollo-Moonlight-Box" --pin=$Env:MY_PIN

        Write-Host "----------------------------------------------------------------"
        Write-Host "üéâ SETUP COMPLETE!" -ForegroundColor Green
        Write-Host "1. Go to https://my.zerotier.com and AUTHORIZE the new member."
        Write-Host "2. Connect via Chrome Remote Desktop: https://remotedesktop.google.com/access"
        Write-Host "3. In the VM, open Edge and go to https://localhost:47990"
        Write-Host "4. Set a Sunshine Username/Pass, then go to the 'PIN' tab."
        Write-Host "5. Open Moonlight on your PC, connect to the ZeroTier IP, and pair."
        Write-Host "----------------------------------------------------------------"

        while ($true) { Start-Sleep -Seconds 60 }
