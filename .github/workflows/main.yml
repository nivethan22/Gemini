name: "Win Latest CRD Only"

on:
  workflow_dispatch:
    inputs:
      CRD_CODE:
        description: "Paste the CRD Code (starts with 4/...)"
        required: true
      CRD_PIN:
        description: "6-digit PIN"
        required: true
        default: "123456"

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: üñ•Ô∏è Set up Virtual Display (CRITICAL)
      # This step must remain to prevent a black screen, as runners are headless.
      # You stated "no virtual display alr" but this is required for successful CRD streaming.
      # If you are absolutely sure you don't need it, you can remove this step.
      run: |
        $url = "https://www.amyuni.com/downloads/usbmmidd_v2.zip"
        $dest = "$env:TEMP\usbmmidd.zip"
        Invoke-WebRequest -Uri $url -OutFile $dest
        Expand-Archive -Path $dest -DestinationPath "C:\usbmmidd" -Force
        cd C:\usbmmidd
        certutil -addstore "TrustedPublisher" .\usbmmidd.cer
        .\deviceinstaller64.exe install usbmmidd.inf usbmmidd
        .\deviceinstaller64.exe enableidd 1

    - name: ‚¨áÔ∏è Install Chrome Remote Desktop
      run: |
        $crdUrl = "https://dl.google.com/dl/edgedl/chrome-remote-desktop/chromeremotedesktophost.msi"
        $crdDest = "$env:TEMP\crd.msi"
        Invoke-WebRequest -Uri $crdUrl -OutFile $crdDest
        Start-Process msiexec.exe -ArgumentList "/i `"$crdDest`" /qn" -Wait
        Start-Sleep -Seconds 5

    - name: üîó Register Host
      shell: pwsh
      run: |
        $ErrorActionPreference = 'Stop'
        
        # Define the base executable path
        $crdExecutable = "$env:ProgramFiles(x86)\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        
        # Fallback for 64-bit installation path
        if (-not (Test-Path $crdExecutable)) {
            $crdExecutable = "$env:ProgramFiles\Google\Chrome Remote Desktop\CurrentVersion\remoting_start_host.exe"
        }
        
        # Check if the executable exists
        if (-not (Test-Path $crdExecutable)) {
            Write-Error "‚ùå Chrome Remote Desktop executable not found at: $crdExecutable"
            exit 1
        }
        
        Write-Host "‚úÖ Executable found at: $crdExecutable"
        
        # Run the registration command using the call operator (&)
        # Note: We now reference the GitHub input directly
        & $crdExecutable --code="${{ github.event.inputs.CRD_CODE }}" `
                         --redirect-url="https://remotedesktop.google.com/_/oauthredirect" `
                         --name="GitHub-Win-Latest" `
                         --pin="${{ github.event.inputs.CRD_PIN }}"
        
        Write-Host "‚úÖ CRD Host registered successfully."

    - name: üïí Keep Alive (6 Hours)
      run: |
        Write-Host "Connect at https://remotedesktop.google.com/access"
        # Simple loop to keep CPU active and runner alive
        for ($i=0; $i -lt 360; $i++) {
            Start-Sleep -Seconds 60
            Write-Host "Time remaining: $(360 - $i) minutes"
        }
