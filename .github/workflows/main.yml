name: Windows Hybrid - Gaming Runner (v4)

on:
  workflow_dispatch:
    inputs:
      ZEROTIER_NETWORK_ID:
        description: 'ZeroTier Network ID (e.g., 8056c2e21c32c4b8)'
        required: true

jobs:
  run-cloud-gaming:
    runs-on: windows-latest
    
    # 1. Increase Timeout and Enable VCPU/VGPU
    timeout-minutes: 360 # 6 hours max run time
    env:
      VCPUS: 2
      VRAM: 8
      NVIDIA: true
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # --- CUSTOMIZATION STEPS ---

      - name: Disable Windows Test Mode
        shell: powershell
        run: |
          # Disabling test mode is necessary for some games/apps to run correctly.
          bcdedit.exe /set TESTSIGNING OFF
          Write-Host "Windows Test Mode has been disabled."

      - name: Re-Install Microsoft Store and Dependencies
        shell: powershell
        run: |
          # The Windows GitHub runner image sometimes removes or breaks the Microsoft Store.
          # Re-installing it is necessary for Xbox/Game Pass games and other UWP apps.
          Write-Host "Attempting to re-register Microsoft Store components..."
          Add-AppxPackage -Register "C:\Program Files\WindowsApps\Microsoft.WindowsStore_*.0_x64__8wekyb3d8bbwe\AppxManifest.xml" -DisableDevelopmentMode
          Add-AppxPackage -Register "C:\Program Files\WindowsApps\Microsoft.UI.Xaml.2.8_*.0_x64__8wekyb3d8bbwe\AppxManifest.xml" -DisableDevelopmentMode
          Add-AppxPackage -Register "C:\Program Files\WindowsApps\Microsoft.VCLibs.140.00.UWPDesktop_*.0_x64__8wekyb3d8bbwe\AppxManifest.xml" -DisableDevelopmentMode
          Write-Host "Microsoft Store components re-registered. You may need to restart the runner."
      
      # --- SETUP: SUNSHINE & ZEROTIER ---

      - name: Install Sunshine Game Streaming Server
        shell: powershell
        run: |
          $url = "https://github.com/LizardByte/Sunshine/releases/latest/download/sunshine-windows-portable.zip"
          $zipFile = "$env:TEMP\sunshine.zip"
          $extractDir = "C:\sunshine"
          
          # Download and extract Sunshine
          Invoke-WebRequest -Uri $url -OutFile $zipFile
          Expand-Archive -Path $zipFile -DestinationPath $extractDir -Force
          
          # Create a basic configuration file to ensure it runs immediately
          New-Item -Path "$extractDir\config\sunshine.conf" -ItemType File -Force
          
          # Run Sunshine as a service
          Start-Service -Name "sunshine"
          Write-Host "Sunshine installed and service started."

      - name: Install and Join ZeroTier Network
        shell: powershell
        run: |
          $networkId = "${{ github.event.inputs.ZEROTIER_NETWORK_ID }}"
          Write-Host "Installing ZeroTier..."
          
          # Use Chocolatey to install ZeroTier
          choco install zerotier-one --confirm
          
          # Join the specified network
          & "C:\Program Files\ZeroTier\One\zerotier-cli.exe" join $networkId
          Write-Host "Successfully joined ZeroTier network ID: $networkId"
          
          # Wait a few seconds for network connection to stabilize
          Start-Sleep -Seconds 10
          
      # --- RUNNER LIFETIME & MONITORING ---

      - name: Start Chrome Remote Desktop and Keep Alive
        uses: benc-uk/action-desktop@v1.2.0
        with:
          rdp-port: 3389 
          rdp-keep-alive: true
          rdp-password: ${{ secrets.RDP_PASSWORD }} # Use your RDP secret here
          rdp-user: ${{ secrets.RDP_USER }} # Use your RDP secret here
          rdp-timeout-minutes: 360 # Matches job timeout

      - name: Wait for Manual Termination
        run: echo "Runner is live. Connect via ZeroTier IP and Moonlight. This job will run until the timeout is reached or it is manually cancelled."
        shell: powershell
        # This job step runs indefinitely until the workflow job is cancelled or times out.
        # It ensures the runner stays active for streaming.
        timeout-minutes: 360
        if: always()
