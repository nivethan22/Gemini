name: Apollo Moonlight (Sunshine Host - EXPERIMENTAL)

on:
  workflow_dispatch:
    inputs:
      stream_pin:
        description: 'Set your 4-digit PIN for Moonlight Client pairing (Default: 1234).'
        required: false
        default: '1234'

jobs:
  sunshine_host:
    # IMPORTANT: We stick to windows-latest as it's the only supported OS for Sunshine on GitHub Actions.
    runs-on: windows-latest

    steps:
      # 1. ‚öôÔ∏è Setup Environment & Pre-Requisites
      - name: ‚öôÔ∏è Setup Environment & Pre-Requisites
        run: |
          # Disable the "Server Manager" popup
          Set-ItemProperty -Path 'HKLM:\SOFTWARE\Microsoft\ServerManager' -Name 'DoNotOpenServerManagerAtLogon' -Value 1
          
          # Enable script execution for this session
          Set-ExecutionPolicy -Scope Process -ExecutionPolicy Bypass -Force
          
          # Start Audio Service for game audio
          Start-Service "Audiosrv"
          Set-Service "Audiosrv" -StartupType Automatic

      # 2. ‚ö° VM Optimization (Debloat) - Keeping for better performance
      - name: ‚ö° Debloat and Optimize Windows Server
        shell: powershell
        run: |
          Write-Host "Starting system optimization..."
          # Disable Unnecessary Services
          $ServicesToDisable = @("Fax", "PrintSpooler", "WSearch", "DiagTrack", "cbdhsvc", "MapsBroker", "OneSyncSvc", "TrkWks", "dmwappushservice", "DoSvc")
          foreach ($svc in $ServicesToDisable) {
              try { Get-Service -Name $svc | Set-Service -StartupType Disabled -ErrorAction Stop } catch {}
          }
          # Disable Telemetry via Registry
          Set-ItemProperty -Path "HKLM:\SOFTWARE\Policies\Microsoft\Windows\DataCollection" -Name "AllowTelemetry" -Value 0 -Type DWord -Force
          # Visual Performance Tweaks
          [byte[]]$bytes = 0x90, 0x12, 0x01, 0x80, 0x10, 0x00, 0x00, 0x00
          Set-ItemProperty -Path 'HKCU:\Control Panel\Desktop' -Name 'UserPreferencesMask' -Value $bytes -Type Binary -Force
          Write-Host "Optimization complete."

      # 3. üñ•Ô∏è Install ViGEmBus and Parsec Virtual Display Driver (Crucial for Headless Stream)
      # Sunshine/Moonlight needs a display to capture, so we use a virtual one.
      - name: üñ•Ô∏è Install Virtual Display Driver Prerequisites
        run: |
          Write-Host "Installing ViGEmBus..."
          # ViGEmBus is needed for virtual controller support (optional but good practice)
          $vigemUrl = "https://github.com/ViGEm/ViGEmBus/releases/download/v1.17.333.0/ViGEmBus_Setup_1.17.333.0.exe"
          Invoke-WebRequest -Uri $vigemUrl -OutFile "ViGEmBus_Setup.exe"
          Start-Process -FilePath ".\ViGEmBus_Setup.exe" -ArgumentList "/S" -Wait
          
          # NOTE: Installing a virtual display is highly complex in a CI environment.
          # The system may need a reboot which GitHub Actions cannot reliably handle mid-job.
          # We will skip direct driver installation and hope Sunshine can capture the session.

      # 4. ‚¨áÔ∏è Install Sunshine Host
      - name: ‚¨áÔ∏è Install Sunshine Host
        run: |
          Write-Host "Downloading Sunshine MSI..."
          # Using the latest stable release link for Sunshine (adjust as necessary)
          $sunshineUrl = "https://github.com/LizardByte/Sunshine/releases/download/v0.22.0/Sunshine-v0.22.0-windows-installer.exe"
          Invoke-WebRequest -Uri $sunshineUrl -OutFile "sunshine.exe"
          
          Write-Host "Installing Sunshine..."
          # Run the installer silently. This may still require user interaction.
          Start-Process -FilePath ".\sunshine.exe" -ArgumentList "/S" -Wait
          
          # Sunshine configuration files are usually in C:\ProgramData\Sunshine\
          
      # 5. üîë Configure and Start Sunshine
      - name: üîë Configure and Start Sunshine
        env:
          MY_PIN: ${{ inputs.stream_pin }}
        run: |
          Write-Host "Setting initial PIN in the configuration (if supported via CLI/Config)..."
          # NOTE: Sunshine configuration (PIN, paths) is usually done via its web UI.
          # Automated pre-configuration via CLI is not directly supported, so the user 
          # will have to complete the pairing process manually via the web interface.
          
          # Wait for Sunshine service to start/be registered
          Start-Sleep -Seconds 10
          
          Write-Host "Attempting to start/ensure Sunshine service is running..."
          try {
            Start-Service "sunshine"
            Set-Service "sunshine" -StartupType Automatic
            Write-Host "Sunshine service started successfully."
          } catch {
            Write-Error "Could not start Sunshine service. It may be running under a different name."
          }

      # 6. üö® Output Instructions and Keep Alive
      - name: üõë Keep Alive and Display Access Info
        env:
          MY_PIN: ${{ inputs.stream_pin }}
        run: |
          Write-Host "--------------------------------------------------------"
          Write-Host "üì¢ SUNSHINE HOST IS ONLINE (EXPERIMENTAL)" -ForegroundColor Yellow
          Write-Host "You must use the Chrome Remote Desktop link to access the runner's desktop FIRST."
          Write-Host "Then, open the Sunshine Web UI (http://localhost:47990) to get the actual pairing code."
          Write-Host "--------------------------------------------------------"
          
          Write-Host "Returning to Chrome Remote Desktop setup for initial access..."
          # Re-implementing the CRD setup to get a desktop to interact with the Sunshine host.
          # This requires the user to run the *original* CRD workflow first to get the auth_code.
          # Since we don't have the CRD auth_code in this workflow, we just loop:
          Write-Host "To manage Sunshine, you need another way to access the desktop (e.g., VNC or CRD)."
          Write-Host "This job will now keep running. Connect to the IP shown in the logs (or via CRD/VNC)."
          Write-Host "PIN for Moonlight Client pairing will be set in the web UI."
          Write-Host "--------------------------------------------------------"
          
          while ($true) { Start-Sleep -Seconds 60 }
